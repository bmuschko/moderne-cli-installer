name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-installer:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Build installer (Unix)
        if: runner.os != 'Windows'
        run: go build -o moderne-cli-installer .

      - name: Build installer (Windows)
        if: runner.os == 'Windows'
        run: go build -o moderne-cli-installer.exe .

      - name: Run installer (Unix)
        if: runner.os != 'Windows'
        run: ./moderne-cli-installer

      - name: Run installer (Windows)
        if: runner.os == 'Windows'
        run: .\moderne-cli-installer.exe

      - name: Verify installation (Unix)
        if: runner.os != 'Windows'
        run: |
          # Find the installed JAR
          JAR_PATH=$(ls $HOME/.moderne/bin/moderne-cli-*.jar 2>/dev/null | head -1)

          if [ -z "$JAR_PATH" ]; then
            echo "JAR file not found"
            exit 1
          fi

          echo "JAR file exists at: $JAR_PATH"
          ls -lh "$JAR_PATH"

          # Run mod --version
          MOD_OUTPUT=$(java -jar "$JAR_PATH" --version 2>&1)
          echo "mod --version output:"
          echo "$MOD_OUTPUT"

      - name: Verify installation (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # Find the installed JAR
          $JAR_PATH = Get-ChildItem "$env:USERPROFILE\.moderne\bin\moderne-cli-*.jar" | Select-Object -First 1

          if (-not $JAR_PATH) {
            Write-Host "JAR file not found"
            exit 1
          }

          Write-Host "JAR file exists at: $($JAR_PATH.FullName)"
          Get-Item $JAR_PATH | Select-Object FullName, Length

          # Run mod --version
          $MOD_OUTPUT = java -jar "$($JAR_PATH.FullName)" --version 2>&1
          Write-Host "mod --version output:"
          Write-Host $MOD_OUTPUT
